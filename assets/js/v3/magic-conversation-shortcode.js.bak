(function($) {
	window.startMagicConversation = function(form_id, container_selector, style) {
		var mcfgf_global = window.mcfgf_global;
		if(!mcfgf_global) return;

		if(!style) style = "width: 100%; height: 300px";

		var ajax_url = mcfgf_global.ajax_url;
		var oldConversation = $('#magic_conversation_container');
		if(oldConversation.length > 0) {
			oldConversation.remove();
		}

		$.get(ajax_url+'?action=gf_button_get_form&embed=1&form_id='+form_id, function(response){
			$('<iframe id="magic_conversation_frame" src="ajax_url+'?action=gf_button_get_form&embed=1&form_id='+form_id" style="'+style+';overflow:hidden;"></iframe> ').appendTo(container_selector).html(response);
  		// $('<div id="magic_conversation_container" style="'+style+';overflow:hidden;"></div>').appendTo(container_selector).html(response);//.fadeIn();

  		if(window['gformInitDatepicker']) {gformInitDatepicker();}

  		//tb_show("Modal title", "#TB_inline?inlineId=modal_container");
  		
  		window.loadMagicConversationForm(form_id);
  		window.ConversationalForm == null;

  		//mobile full screen
  		$('body').toggleClass('mcfgfp-mobile-no-scroll');

  		var pum = container_selector.parents('.pum');
  		// console.log('pum001', pum);
  		if(pum.length > 0) {
  			setTimeout(function(){
					pum.css('opacity', '1');
  				// console.log('pum002', pum.css('opacity'));
  			}, 200);
  		}
		});
	}

	function autoEmbedMagicConversation(mc) {
		var form_id = mc.attr('form-id');
		window.startMagicConversation(form_id, mc);
	}

	//auto load conversation generated by short code
	$(document).ready(function(){
		var mc = $('magic-conversation');
		if(mc.length > 0 ) {
			var pum = mc.parents('.pum');
			if(pum.length > 0) {

				pum.on('pumBeforeOpen', function () {
					var $popup = $(this);
					$popup.css('opacity', '0');
					autoEmbedMagicConversation(mc);
			  }); 
				return;
			}
			autoEmbedMagicConversation(mc);
		}

		$(document).on('click', '.open-mc', function(){
			var target = $(this).attr('mc-target');
			var conversation_id = $(this).attr('mc-id');
			return false;
		});
		
	});

})(jQuery);